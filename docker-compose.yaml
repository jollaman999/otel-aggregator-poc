services:
  keepalived:
    image: osixia/keepalived:2.0.20
    container_name: keepalived-${NODE_NAME}
    restart: always
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_BROADCAST
      - NET_RAW
    environment:
      - NODE_IP=${NODE_IP}
      - PEER_IP=${PEER_IP}
      - VIP=${VIP}
      - KEEPALIVED_PRIORITY=${KEEPALIVED_PRIORITY}
      - KEEPALIVED_STATE=${KEEPALIVED_STATE}
      - ROUTER_ID=${ROUTER_ID}
    volumes:
      - ./keepalived/keepalived.conf.template:/etc/keepalived/keepalived.conf.template:ro
      - ./keepalived/setup-keepalived.sh:/usr/local/bin/setup-keepalived.sh:ro
    entrypoint: ["/bin/bash", "/usr/local/bin/setup-keepalived.sh"]

  haproxy:
    image: cmp-haproxy
    build:
      context: ./haproxy
      dockerfile: Dockerfile
      network: host
    container_name: haproxy-${NODE_NAME}
    restart: always
    network_mode: host
    depends_on:
      - keepalived
    environment:
      - NODE_IP=${NODE_IP}
      - PEER_IP=${PEER_IP}
    healthcheck:
      start_period: 120s
      test: ["CMD", "haproxy", "-c", "-f", "/usr/local/etc/haproxy/haproxy.cfg"]
      interval: 10s
      timeout: 10s
      retries: 30

  minio:
    image: cmp-minio
    build:
      context: ./minio
      dockerfile: Dockerfile
      network: host
    container_name: minio-${NODE_NAME}
    hostname: minio-${NODE_NAME}
    restart: always
    network_mode: host
    volumes:
      - /data/volume/otel/minio/data1:/data1
      - /data/volume/otel/minio/data2:/data2
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - MINIO_DISTRIBUTED_MODE_ENABLED=yes
      - MINIO_DISTRIBUTED_NODES=${MINIO_DISTRIBUTED_NODES}
    healthcheck:
      start_period: 120s
      test: ["CMD", "curl", "-f", "http://127.0.0.1:9000/minio/health/live"]
      interval: 10s
      timeout: 10s
      retries: 30

  otel-aggregator:
    image: cmp-otel-aggregator
    build:
      context: .
      dockerfile: Dockerfile
      network: host
    container_name: otel-aggregator-${NODE_NAME}
    restart: always
    network_mode: host
    volumes:
      - ./otel-collector/config.yaml:/etc/otelcol-contrib/config.yaml:ro
    command: ["--config=/etc/otelcol-contrib/config.yaml"]
    environment:
      - NODE_NAME=${NODE_NAME}
    healthcheck:
      start_period: 120s
      test: ["CMD", "curl", "-f", "http://127.0.0.1:9464/metrics"]
      interval: 10s
      timeout: 10s
      retries: 30

  prometheus:
    image: cmp-prometheus
    build:
      context: ./prometheus
      dockerfile: Dockerfile
      network: host
    container_name: prometheus-${NODE_NAME}
    restart: always
    network_mode: host
    depends_on:
      prometheus-init-volumes:
        condition: service_completed_successfully
    volumes:
      - /data/volume/otel/prometheus:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--web.listen-address=0.0.0.0:19090'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--storage.tsdb.min-block-duration=2h'
      - '--storage.tsdb.max-block-duration=2h'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    environment:
      - NODE_NAME=${NODE_NAME}
      - NODE_IP=${NODE_IP}
      - PEER_IP=${PEER_IP}
    healthcheck:
      start_period: 120s
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:19090/-/healthy"]
      interval: 10s
      timeout: 10s
      retries: 30

  prometheus-init-volumes:
    image: busybox:stable
    container_name: prometheus-init-volumes
    restart: no
    network_mode: host
    command: [ "sh", "-c", "chown -R 65534:65534 /prometheus" ]
    volumes:
      - /data/volume/otel/prometheus:/prometheus
    user: root
    init: true

  thanos-sidecar:
    image: thanosio/thanos:v0.40.1
    container_name: thanos-sidecar-${NODE_NAME}
    restart: always
    network_mode: host
    user: "65534:65534"
    volumes:
      - ./thanos/bucket.yml:/etc/thanos/bucket.yml:ro
      - /data/volume/otel/prometheus:/prometheus
      - /data/volume/otel/thanos:/thanos
    command:
      - 'sidecar'
      - '--tsdb.path=/prometheus'
      - '--prometheus.url=http://127.0.0.1:9090'
      - '--grpc-address=0.0.0.0:10901'
      - '--http-address=0.0.0.0:10902'
      - '--objstore.config-file=/etc/thanos/bucket.yml'
    depends_on:
      prometheus:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      start_period: 120s
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:10902/-/healthy"]
      interval: 10s
      timeout: 10s
      retries: 30

  thanos-receiver:
    build:
      context: ./thanos
      dockerfile: Dockerfile
      network: host
    image: cmp-thanos-receiver
    container_name: thanos-receiver-${NODE_NAME}
    restart: always
    network_mode: host
    volumes:
      - ./thanos/bucket.yml:/etc/thanos/bucket.yml:ro
      - ./thanos/hashrings.json.template:/etc/thanos/hashrings.json.template:ro
      - /data/volume/otel/thanos-receiver:/thanos-receiver
    command:
      - 'receive'
      - '--grpc-address=0.0.0.0:10907'
      - '--http-address=0.0.0.0:10909'
      - '--remote-write.address=0.0.0.0:19291'
      - '--tsdb.path=/thanos-receiver'
      - '--objstore.config-file=/etc/thanos/bucket.yml'
      - '--label=receive_replica="${NODE_NAME}"'
      - '--label=replica="${NODE_NAME}"'
      - '--tsdb.retention=2h'
      - '--receive.replication-factor=1'
      - '--receive.local-endpoint=${NODE_IP}:10907'
      - '--receive.hashrings-file=/etc/thanos/hashrings.json'
    environment:
      - NODE_IP=${NODE_IP}
      - PEER_IP=${PEER_IP}
    depends_on:
      thanos-receiver-init-volumes:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:10909/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  thanos-receiver-init-volumes:
    image: busybox:stable
    container_name: thanos-receiver-init-volumes
    restart: no
    network_mode: host
    command: [ "sh", "-c", "chown -R 1001:1001 /thanos-receiver" ]
    volumes:
      - /data/volume/otel/thanos-receiver:/thanos-receiver
    user: root
    init: true

  loki:
    image: grafana/loki:3.4.2
    container_name: loki-${NODE_NAME}
    restart: always
    network_mode: host
    volumes:
      - ./loki/config.yaml:/etc/loki/config.yaml:ro
      - /data/volume/otel/loki:/loki
    command: -config.file=/etc/loki/config.yaml
    depends_on:
      loki-init-volumes:
        condition: service_completed_successfully
      minio:
        condition: service_healthy
    healthcheck:
      start_period: 120s
      test: 'wget --quiet --spider http://127.0.0.1:13100/metrics || exit 1'
      interval: 10s
      timeout: 10s
      retries: 30

  loki-init-volumes:
    image: busybox:stable
    container_name: loki-init-volumes
    restart: no
    network_mode: host
    command: [ "sh", "-c", "chown -R 10001:10001 /loki" ]
    volumes:
      - /data/volume/otel/loki:/loki
    user: root
    init: true
